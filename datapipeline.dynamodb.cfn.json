{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Parameters": {
    "ReadThroughputRatio": {
      "Type": "Number",
      "Default": "0.2",
      "Description": "DynamoDB read throughput ratio"
    },
    "WriteThroughputRatio": {
      "Type": "Number",
      "Default": "0.2",
      "Description": "DynamoDB write throughput ratio"
    },
    "TableName": {
      "Type": "String",
      "Default": "alertmessages",
      "Description": "DynamoDB Table Name"
    },
    "SourceTableRegion": {
      "Type": "String",
      "Default": "us-east-1",
      "Description": "DynamoDB Source Table Region"
    },
    "DestinationTableRegion": {
      "Type": "String",
      "Default": "us-west-2",
      "Description": "DynamoDB Destination Table Region"
    },
    "PipelineLogUri": {
      "Type": "String",
      "Default": "s3://dynamodb-alertmessages",
      "Description": "s3 Uri for Logs"
    }
  },
  "Resources": {
    "DynamoDBCrossRegionCopy": {
      "Type": "AWS::DataPipeline::Pipeline",
      "Properties": {
        "Name": "DynamoDBCrossRegionCopy",
        "Description": "Pipeline to backup DynamoDB data to another region",
        "Activate": "true",
        "ParameterObjects": [
          {
            "Id": "myDDBReadThroughputRatio",
            "Attributes": [
              {
                "Key": "description",
                "StringValue": "DynamoDB read throughput ratio"
              },
              {
                "Key": "type",
                "StringValue": "Double"
              },
              {
                "Key": "default",
                "StringValue": "0.2"
              }
            ]
          },
          {
            "Id": "myDDBWriteThroughputRatio",
            "Attributes": [
              {
                "Key": "description",
                "StringValue": "DynamoDB write throughput ratio"
              },
              {
                "Key": "type",
                "StringValue": "Double"
              },
              {
                "Key": "default",
                "StringValue": "0.2"
              }
            ]
          },
          {
            "Id": "myDDBTableName",
            "Attributes": [
              {
                "Key": "description",
                "StringValue": "DynamoDB Table Name "
              },
              {
                "Key": "type",
                "StringValue": "String"
              },
              {
                "Key": "default",
                "StringValue": "alertmesssages"
              }
            ]
          },
          {
            "Id": "mySourceTableRegion",
            "Attributes": [
              {
                "Key": "description",
                "StringValue": "DynamoDB Source Table Region"
              },
              {
                "Key": "type",
                "StringValue": "String"
              },
              {
                "Key": "default",
                "StringValue": "us-east-1"
              }
            ]
          },
          {
            "Id": "myDestinationTableRegion",
            "Attributes": [
              {
                "Key": "description",
                "StringValue": "DynamoDB Destination Table Region"
              },
              {
                "Key": "type",
                "StringValue": "String"
              },
              {
                "Key": "default",
                "StringValue": "us-west-2"
              }
            ]
          },
          {
            "Id": "myPipelineLogUri",
            "Attributes": [
              {
                "Key": "description",
                "StringValue": "s3 Uri for Logs"
              },
              {
                "Key": "type",
                "StringValue": "String"
              },
              {
                "Key": "default",
                "StringValue": "s3://dynamodb-alertmessages"
              }
            ]
          }
        ],
        "ParameterValues": [
          {
            "Id": "myDDBReadThroughputRatio",
            "StringValue": { "Ref": "ReadThroughputRatio" }
          },
          {
            "Id": "myDDBWriteThroughputRatio",
            "StringValue": { "Ref": "WriteThroughputRatio" }
          },
          {
            "Id": "myDDBTableName",
            "StringValue": { "Ref": "TableName" }
          },
          {
            "Id": "mySourceTableRegion",
            "StringValue": { "Ref": "SourceTableRegion" }
          },
          {
            "Id": "myDestinationTableRegion",
            "StringValue": { "Ref": "DestinationTableRegion" }
          },
          {
            "Id": "myPipelineLogUri",
            "StringValue": { "Ref": "PipelineLogUri" }
          }
        ],
        "PipelineObjects": [
          {
            "Id": "DDBSourceTable",
            "Name": "DDBSourceTable",
            "Fields": [
              {
                "Key": "tableName",
                "StringValue": "#{myDDBTableName}"
              },
              {
                "Key": "type",
                "StringValue": "DynamoDBDataNode"
              },
              {
                "Key": "dataFormat",
                "RefValue": "DDBExportFormat"
              },
              {
                "Key": "readThroughputPercent",
                "StringValue": "#{myDDBReadThroughputRatio}"
              },
              {
                "Key": "region",
                "StringValue": "#{mySourceTableRegion}"
              },
              {
                "Key": "schedule",
                "RefValue": "Every30Minutes"
              }
            ]
          },
          {
            "Id": "DDBDestinationTable",
            "Name": "DDBDestinationTable",
            "Fields": [
              {
                "Key": "tableName",
                "StringValue": "#{myDDBTableName}"
              },
              {
                "Key": "type",
                "StringValue": "DynamoDBDataNode"
              },
              {
                "Key": "dataFormat",
                "RefValue": "DDBExportFormat"
              },
              {
                "Key": "writeThroughputPercent",
                "StringValue": "#{myDDBWriteThroughputRatio}"
              },
              {
                "Key": "region",
                "StringValue": "#{myDestinationTableRegion}"
              },
              {
                "Key": "schedule",
                "RefValue": "Every30Minutes"
              }
            ]
          },
          {
            "Id": "DDBExportFormat",
            "Name": "DDBExportFormat",
            "Fields": [
              {
                "Key": "type",
                "StringValue": "DynamoDBExportDataFormat"
              }
            ]
          },
          {
            "Id": "TableCopyActivity",
            "Name": "TableCopyActivity",
            "Fields": [
              {
                "Key": "resizeClusterBeforeRunning",
                "StringValue": "true"
              },
              {
                "Key": "type",
                "StringValue": "HiveCopyActivity"
              },
              {
                "Key": "input",
                "RefValue": "DDBSourceTable"
              },
              {
                "Key": "runsOn",
                "RefValue": "EmrClusterForCopy"
              },
              {
                "Key": "output",
                "RefValue": "DDBDestinationTable"
              },
              {
                "Key": "schedule",
                "RefValue": "Every30Minutes"
              }
            ]
          },
          {
            "Id": "Every30Minutes",
            "Name": "Every30Minutes",
            "Fields": [
              {
                "Key": "startAt",
                "StringValue": "FIRST_ACTIVATION_DATE_TIME"
              },
              {
                "Key": "type",
                "StringValue": "Schedule"
              },
              {
                "Key": "period",
                "StringValue": "30 Minutes"
              }
            ]
          },
          {
            "Id": "Default",
            "Name": "Default",
            "Fields": [
              {
                "Key": "type",
                "StringValue": "Default"
              },
              {
                "Key": "scheduleType",
                "StringValue": "cron"
              },
              {
                "Key": "failureAndRerunMode",
                "StringValue": "CASCADE"
              },
              {
                "Key": "role",
                "StringValue": "DataPipelineDefaultRole"
              },
              {
                "Key": "resourceRole",
                "StringValue": "DataPipelineDefaultResourceRole"
              },
              {
                "Key": "schedule",
                "RefValue": "Every30Minutes"
              },
              {
                "Key": "pipelineLogUri",
                "StringValue": "#{myPipelineLogUri}"
              }
            ]
          },
          {
            "Id": "EmrClusterForCopy",
            "Name": "EmrClusterForCopy",
            "Fields": [
              {
                "Key": "terminateAfter",
                "StringValue": "2 Hours"
              },
              {
                "Key": "amiVersion",
                "StringValue": "3.3.2"
              },
              {
                "Key": "masterInstanceType",
                "StringValue": "m1.medium"
              },
              {
                "Key": "coreInstanceType",
                "StringValue": "m1.medium"
              },
              {
                "Key": "coreInstanceCount",
                "StringValue": "1"
              },
              {
                "Key": "type",
                "StringValue": "EmrCluster"
              },
              {
                "Key": "region",
                "StringValue": "#{mySourceTableRegion}"
              },
              {
                "Key": "schedule",
                "RefValue": "Every30Minutes"
              }
            ]
          }
        ]
      }
    }
  }
}
